name: npm-release

on:
  workflow_call:
    inputs:
      build-command:
        description: "npm script to run before publishing"
        type: string
        required: false
        default: "build"
      main-branch:
        description: "Main release branch"
        type: string
        required: false
        default: "main"
      dev-branch:
        description: "Dev prerelease branch"
        type: string
        required: false
        default: "dev"
      access:
        description: "npm publish access level (public or restricted)"
        type: string
        required: false
        default: "public"
      package-dir:
        description: "Working directory for the package"
        type: string
        required: false
        default: "."
    secrets:
      npm-token:
        required: true
    outputs:
      new-version:
        description: "New version published"
        value: ${{ jobs.release.outputs.new-version }}

permissions:
  contents: write
  packages: write
  pull-requests: write
  statuses: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.bump.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - uses: oven-sh/setup-bun@v2

      - name: Configure npm token
        shell: bash
        env:
          NPM_TOKEN: ${{ secrets.npm-token }}
        run: |
          npm config set //registry.npmjs.org/:_authToken="$NPM_TOKEN"

      - name: Read package.json
        id: pkg
        shell: bash
        working-directory: ${{ inputs.package-dir }}
        run: |
          name=$(jq -r .name package.json)
          echo "name=$name" >> "$GITHUB_OUTPUT"

      - name: Get latest npm version
        id: npm_tag
        uses: beepbop-labs/github-actions/.github/actions/get-npm-version@main
        with:
          package-name: ${{ steps.pkg.outputs.name }}
          dev-branch: ${{ inputs.dev-branch }}

      - name: Determine new version
        id: bump
        uses: beepbop-labs/github-actions/.github/actions/calc-new-version@main
        with:
          npm-version: ${{ steps.npm_tag.outputs.version }}
          main-branch: ${{ inputs.main-branch }}
          dev-branch: ${{ inputs.dev-branch }}

      - name: Build
        shell: bash
        working-directory: ${{ inputs.package-dir }}
        if: ${{ steps.bump.outputs.version != '' }}
        env:
          BUILD_COMMAND: ${{ inputs.build-command }}
        run: |
          bun install
          bun run "$BUILD_COMMAND"

      - name: Publish
        if: ${{ steps.bump.outputs.version != '' }}
        uses: beepbop-labs/github-actions/.github/actions/npm-publish@main
        with:
          version: ${{ steps.bump.outputs.version }}
          dev-branch: ${{ inputs.dev-branch }}
          access: ${{ inputs.access }}
          working-directory: ${{ inputs.package-dir }}
