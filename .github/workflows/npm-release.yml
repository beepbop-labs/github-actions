name: npm-release

on:
  workflow_call:
    inputs:
      build-command:
        description: "npm script to run before publishing"
        type: string
        required: false
        default: "build"
      bump-level:
        description: "Version bump level (major, minor, patch)"
        type: string
        required: false
        default: "patch"
      main-branch:
        description: "Main release branch"
        type: string
        required: false
        default: "main"
      dev-branch:
        description: "Dev prerelease branch"
        type: string
        required: false
        default: "dev"
      access:
        description: "npm publish access level (public or restricted)"
        type: string
        required: false
        default: "public"
      package-dir:
        description: "Working directory for the package"
        type: string
        required: false
        default: "."
      force-publish:
        description: "Skip change detection and always publish"
        type: boolean
        required: false
        default: false
    secrets:
      npm-token:
        required: true
    outputs:
      new-version:
        description: "New version published"
        value: ${{ jobs.release.outputs.new-version }}

permissions:
  contents: write
  packages: write
  pull-requests: write
  statuses: write

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      new-version: ${{ steps.bump.outputs.version }}
    env:
      NPM_TOKEN: ${{ secrets.npm-token }}
      NPM_CONFIG_TOKEN: ${{ secrets.npm-token }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Read package.json
        id: pkg
        shell: bash
        working-directory: ${{ inputs.package-dir }}
        run: |
          name=$(jq -r .name package.json)
          echo "name=$name" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Package: $name"

      - name: Get latest npm version
        id: npm_tag
        uses: beepbop-labs/github-actions/.github/actions/get-npm-version@main
        with:
          package-name: ${{ steps.pkg.outputs.name }}
          dev-branch: ${{ inputs.dev-branch }}

      - name: Determine new version
        id: bump
        uses: beepbop-labs/github-actions/.github/actions/calc-new-version@main
        with:
          npm-version: ${{ steps.npm_tag.outputs.version }}
          bump-level: ${{ inputs.bump-level }}
          main-branch: ${{ inputs.main-branch }}
          dev-branch: ${{ inputs.dev-branch }}

      - name: Build
        shell: bash
        working-directory: ${{ inputs.package-dir }}
        if: ${{ steps.bump.outputs.version != '' }}
        env:
          BUILD_COMMAND: ${{ inputs.build-command }}
        run: |
          bun install --frozen-lockfile
          bun run "$BUILD_COMMAND"
          echo "âœ… Build complete"

      - name: Check for changes
        id: changes
        if: ${{ steps.bump.outputs.version != '' && inputs.force-publish != true }}
        uses: beepbop-labs/github-actions/.github/actions/check-changes@main
        with:
          package-name: ${{ steps.pkg.outputs.name }}
          npm-version: ${{ steps.npm_tag.outputs.version }}
          working-directory: ${{ inputs.package-dir }}

      - name: Publish
        if: ${{ steps.bump.outputs.version != '' && (inputs.force-publish == true || steps.changes.outputs.has-changes == 'true') }}
        uses: beepbop-labs/github-actions/.github/actions/npm-publish@main
        with:
          version: ${{ steps.bump.outputs.version }}
          dev-branch: ${{ inputs.dev-branch }}
          access: ${{ inputs.access }}
          working-directory: ${{ inputs.package-dir }}
