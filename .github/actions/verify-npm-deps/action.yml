name: Check NPM Dependencies
description: Check that package.json only contains valid npm-resolvable dependencies

inputs:
  working-directory:
    description: "Working directory for the package"
    required: false
    default: "."

runs:
  using: composite
  steps:
    - name: Check for valid semver dependencies
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” Checking for valid semver dependencies in package.json..."

        # Function to check if version is valid semver
        is_valid_semver() {
          local version="$1"

          # Check for invalid non-semver patterns first
          if [[ "$version" =~ ^(workspace|file|link|git|http|https): ]]; then
            return 1
          fi

          # Check for valid semver patterns that npm can resolve:
          # Exact versions: 1.2.3, 0.1.0 (MAJOR.MINOR.PATCH format only)
          # Caret ranges: ^1.2.3, ^0.1.0 (allows compatible updates)
          # Tilde ranges: ~1.2.3, ~1.2.0 (allows patch-level updates)
          # Comparison operators: >=1.2.3, >1.2.0, <2.0.0, <=1.2.3, =1.2.3
          # Pre-release versions: 1.2.3-alpha.1, 1.2.3-beta.2, 1.2.3-rc.1
          # npm dist-tags: latest, stable, beta, alpha, next, canary, rc
          # NOTE: Build metadata (+build.1) is ignored by npm for resolution
          # NOTE: Dist-tags work but are discouraged for production dependencies
          if [[ "$version" =~ ^[\^\~\>\<\=\*]?[0-9]+(\.[0-9]+)*(\.[0-9]+)*(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            return 0
          fi

          # Allow complex version ranges like '>=1.0.0 <2.0.0', '1.0.0 - 2.0.0'
          if [[ "$version" =~ ^(\>\=|\>|\<\=|\<|=)[0-9]+(\.[0-9]+)*(\.[0-9]+)*.*$ ]]; then
            return 0
          fi

          # Allow npm dist-tags: latest, stable, beta, alpha, next, canary, rc
          # NOTE: Dist-tags work for npm resolution but are generally discouraged for production
          # dependencies as they can cause non-reproducible builds and unexpected updates
          if [[ "$version" =~ ^(latest|stable|beta|alpha|next|canary|rc)$ ]]; then
            return 0
          fi

          # Allow wildcard for publishing (not typically used for dependencies)
          if [[ "$version" == "*" ]]; then
            return 0
          fi

          # If none of the patterns match, it's invalid
          return 1
        }

        # Use an array to store invalid dependencies
        declare -a invalid_deps_array=()

        # Single jq call to process all dependency types efficiently
        while IFS= read -r line; do
          if [[ -n "$line" && "$line" != "null" ]]; then
            IFS='|' read -r dep version type <<< "$line"
            if ! is_valid_semver "$version"; then
              invalid_deps_array+=("$dep|$version|$type")
            fi
          fi
        done < <(jq -r '
          (.dependencies // {}) as $deps |
          (.devDependencies // {}) as $devDeps |
          (.peerDependencies // {}) as $peerDeps |
          (
            $deps | to_entries[] | "\(.key)|\(.value)|dependencies"
          ),
          (
            $devDeps | to_entries[] | "\(.key)|\(.value)|devDependencies"
          ),
          (
            $peerDeps | to_entries[] | "\(.key)|\(.value)|peerDependencies"
          )
        ' package.json 2>/dev/null)

        if [[ ${#invalid_deps_array[@]} -gt 0 ]]; then
          echo "âŒ Found invalid dependency versions in package.json:"
          for dep_info in "${invalid_deps_array[@]}"; do
            IFS='|' read -r dep version type <<< "$dep_info"
            echo "  - $dep@$version ($type)"
          done
          echo ""
          echo "This workflow requires all dependencies to use valid semver versions."
          echo "Use 'npm-release-turborepo-workspace' workflow for workspace dependencies."
          exit 1
        else
          echo "âœ… All dependencies have valid semver versions"
        fi
