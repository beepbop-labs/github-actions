name: npm publish
description: Publish package to npm

inputs:
  version:
    description: "Version to publish"
    required: true
  dev-branch:
    description: "Dev prerelease branch"
    required: false
    default: "dev"
  access:
    description: "npm publish access level (public or restricted)"
    required: false
    default: "public"
  working-directory:
    description: "Working directory for the package"
    required: false
    default: "."

runs:
  using: composite
  steps:
  - name: Publish to npm (bun)
    shell: bash
    working-directory: ${{ inputs.working-directory }}
    env:
      DEV_BRANCH: ${{ inputs.dev-branch }}
      NEW_VERSION: ${{ inputs.version }}
      ACCESS: ${{ inputs.access }}
      # bun publish reads this (or .npmrc)
      NPM_TOKEN: ${{ env.NPM_TOKEN }}
    run: |
      # bump version WITHOUT npm (avoids workspace:* parsing)
      tmp="$(mktemp)"
      jq --arg v "$NEW_VERSION" '.version=$v' package.json > "$tmp" && mv "$tmp" package.json

      branch=${GITHUB_REF##*/}
      pkg_name=$(jq -r .name package.json)

      if [[ "$branch" == "$DEV_BRANCH" ]]; then
        bun publish --tag dev --access "$ACCESS"
        echo "ðŸš€ Published ${pkg_name}@${NEW_VERSION} (tag: dev)"
      else
        bun publish --access "$ACCESS"
        echo "ðŸš€ Published ${pkg_name}@${NEW_VERSION} (tag: latest)"
      fi
